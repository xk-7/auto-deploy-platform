<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Compose Deploy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 70px; background-color: #f8f9fa; }
        .nav-link-custom { font-weight: 500; color: #555; margin-left: 10px; }
        .nav-link-custom:hover { background-color: #e2e6ea; border-radius: 5px; color: #000; }
        .navbar-light .navbar-nav .nav-link.active { background-color: #0d6efd; color: #fff !important; border-radius: 5px; }
        .compose-card { margin-bottom: 15px; }
        #logs { background: #000; color: #0f0; height: 300px; overflow: auto; padding: 10px; }
    </style>
</head>
<body>

<!-- å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">ğŸš€ Auto Deploy</a>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/">ğŸ“Š System Monitor</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/static/containers.html">ğŸ“¦ Containers</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/static/containers-create.html">ğŸš€ Deploy</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/static/compose.html">ğŸ§© Compose</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/static/files.html">ğŸ“‚ File Manager</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- ä¸»ä½“ -->
<div class="container mt-4">
    <h1 class="mb-4">ğŸ§© Compose åº”ç”¨éƒ¨ç½²</h1>

    <!-- ä¸Šä¼  -->
    <div class="card mb-4">
        <div class="card-header">ğŸ“„ ä¸Šä¼  docker-compose.yml</div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Compose åç§° (æ ‡è¯†ç¬¦)</label>
                <input type="text" id="compose-name" class="form-control" placeholder="å¦‚ my-app">
            </div>
            <div class="mb-3">
                <label class="form-label">é€‰æ‹© Compose æ–‡ä»¶</label>
                <input type="file" id="compose-file" class="form-control">
            </div>
            <button class="btn btn-success" onclick="uploadCompose()">ä¸Šä¼ </button>
        </div>
    </div>

    <!-- Compose åº”ç”¨åˆ—è¡¨ -->
    <div class="card mb-4">
        <div class="card-header">ğŸ“‚ å·²ä¸Šä¼  Compose åº”ç”¨</div>
        <div class="card-body" id="compose-list">
            <p>åŠ è½½ä¸­...</p>
        </div>
    </div>

    <!-- æ—¥å¿— -->
    <div class="card">
        <div class="card-header">ğŸ“œ æ‰§è¡Œæ—¥å¿—</div>
        <div class="card-body">
            <pre id="logs">ç­‰å¾…æ“ä½œ...</pre>
        </div>
    </div>
</div>

<!-- å®¹å™¨è¯¦æƒ… Modal -->
<div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Compose è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="composeModalBody">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const CONFIG = { apiBaseUrl: "/api/v1", wsBaseUrl: `ws://13.212.57.194:8081/api/v1` };
    let ws;
    let logsDiv = document.getElementById("logs");

    async function uploadCompose() {
        let name = document.getElementById("compose-name").value.trim();
        let file = document.getElementById("compose-file").files[0];

        if (!name || !file) {
            alert("è¯·å¡«å†™åç§°å¹¶é€‰æ‹©æ–‡ä»¶");
            return;
        }

        let formData = new FormData();
        formData.append("name", name);
        formData.append("compose_file", file);

        let res = await fetch(`${CONFIG.apiBaseUrl}/compose/upload`, {
            method: "POST",
            body: formData
        });
        if (res.ok) {
            alert("âœ… ä¸Šä¼ æˆåŠŸï¼");
            loadComposeStatus();
        } else {
            alert("âŒ ä¸Šä¼ å¤±è´¥");
        }
    }

    async function loadComposeStatus() {
        let res = await fetch(`${CONFIG.apiBaseUrl}/compose/status`);
        let data = await res.json();

        let listDiv = document.getElementById("compose-list");
        listDiv.innerHTML = "";

        if (data.apps.length === 0) {
            listDiv.innerHTML = `<p class="text-muted">æš‚æ—  Compose åº”ç”¨</p>`;
            return;
        }

        data.apps.forEach(app => {
            let row = `<div class="card compose-card">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="showComposeDetail('${app.name}')">ğŸŸ¢ ${app.name}</button>
                        <span class="ms-3 text-success">${app.status}</span>
                    </div>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="startCompose('${app.name}')">Start</button>
                        <button class="btn btn-danger btn-sm me-2" onclick="stopCompose('${app.name}')">Stop</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteCompose('${app.name}')">Delete</button>
                    </div>
                </div>
            </div>`;
            listDiv.innerHTML += row;
        });
    }

    async function showComposeDetail(name) {
        let res = await fetch(`${CONFIG.apiBaseUrl}/compose/status`);
        let data = await res.json();

        let targetApp = data.apps.find(a => a.name === name);
        if (!targetApp) {
            alert("æœªæ‰¾åˆ°è¯¥ Compose åº”ç”¨ï¼");
            return;
        }

        let modalBody = `<p><strong>${targetApp.name}</strong> çŠ¶æ€: ${targetApp.status}</p>`;
        modalBody += `<table class="table table-sm">
          <thead><tr><th>ID</th><th>åç§°</th><th>é•œåƒ</th><th>çŠ¶æ€</th><th>ç«¯å£</th></tr></thead>
          <tbody>`;
        targetApp.containers.forEach(c => {
            modalBody += `<tr>
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${c.image}</td>
              <td>${c.status}</td>
              <td>${c.ports}</td>
            </tr>`;
        });
        modalBody += `</tbody></table>`;

        document.getElementById("composeModalBody").innerHTML = modalBody;

        let modal = new bootstrap.Modal(document.getElementById('composeModal'));
        modal.show();
    }

    async function startCompose(name) {
        logsDiv.innerText = "ğŸ”„ æ­£åœ¨å¯åŠ¨...\n";
        ws = new WebSocket(`${CONFIG.wsBaseUrl}/ws/compose-logs?name=${name}`);
        ws.onmessage = function(event) {
            logsDiv.innerText += event.data + "\n";
            logsDiv.scrollTop = logsDiv.scrollHeight;
        };
        await fetch(`${CONFIG.apiBaseUrl}/compose/up`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name })
        });
        loadComposeStatus();
    }

    async function stopCompose(name) {
        logsDiv.innerText = "ğŸ”„ æ­£åœ¨åœæ­¢...\n";
        await fetch(`${CONFIG.apiBaseUrl}/compose/down`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name })
        });
        logsDiv.innerText += "âœ… åœæ­¢å®Œæˆ\n";
        loadComposeStatus();
    }

    async function deleteCompose(name) {
        if (!confirm(`ç¡®è®¤è¦åˆ é™¤ Compose åº”ç”¨ ${name} å—ï¼Ÿ`)) return;
        await fetch(`${CONFIG.apiBaseUrl}/compose/delete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name })
        });
        loadComposeStatus();
    }

    //åˆ¤æ–­æŒ‰é’®
    function highlightNav() {
        let navLinks = document.querySelectorAll('.nav-link-custom');
        let currentPath = window.location.pathname;
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.classList.add('active');
            }
        });
    }

    window.onload = function() {
        loadComposeStatus();
        highlightNav(); // åŠ¨æ€é«˜äº®
    };
</script>

</body>
</html>
