<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»ŸçŠ¶æ€ç›‘æ§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 70px; background-color: #f8f9fa; }
        .nav-link-custom {
            font-weight: 500;
            color: #555;
            margin-left: 10px;
            transition: all 0.3s ease-in-out;
        }
        .nav-link-custom:hover {
            background-color: #e2e6ea;
            border-radius: 5px;
            color: #000;
        }
        .navbar-light .navbar-nav .nav-link.active {
            background-color: #0d6efd;
            color: #fff !important;
            border-radius: 5px;
        }
        .progress { height: 20px; }
        #log { background: #000; color: #0f0; height: 300px; overflow: auto; padding: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>

<!-- å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">ğŸš€ Auto Deploy</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/">ğŸ“Š ç³»ç»Ÿç›‘æ§</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/static/containers.html">ğŸ“¦ å®¹å™¨</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/static/containers-create.html">ğŸš€ éƒ¨ç½²</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/static/compose.html">ğŸ§© Compose</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="/static/files.html">ğŸ“‚ æ–‡ä»¶ç®¡ç†</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- ä¸»ä½“å†…å®¹ -->
<div class="container mt-4">
    <h1 class="mb-4">ğŸ“Š ç³»ç»ŸçŠ¶æ€ç›‘æ§</h1>

    <!-- ç³»ç»Ÿç›‘æ§å¡ç‰‡ -->
    <div class="card mb-4">
        <div class="card-header">å®æ—¶ç³»ç»Ÿç›‘æ§ (WebSocket)</div>
        <div class="card-body">
            <p><strong>è¿è¡Œæ—¶é—´:</strong> <span id="uptime">--</span></p>
            <p><strong>è´Ÿè½½å‡å€¼:</strong> <span id="load">--</span></p>

            <p class="mb-1"><strong>CPU ä½¿ç”¨ç‡:</strong> <span id="cpu">--%</span></p>
            <div class="progress mb-3">
                <div id="cpu-bar" class="progress-bar bg-info" role="progressbar"></div>
            </div>

            <p class="mb-1"><strong>å†…å­˜:</strong> <span id="memory">-- / -- GB</span></p>
            <div class="progress mb-3">
                <div id="memory-bar" class="progress-bar bg-warning" role="progressbar"></div>
            </div>

            <p class="mb-1"><strong>ç£ç›˜:</strong> <span id="disk">-- / -- GB</span></p>
            <div class="progress">
                <div id="disk-bar" class="progress-bar bg-success" role="progressbar"></div>
            </div>
        </div>
    </div>

    <!-- Ansible Playbook æ‰§è¡Œ -->
    <div class="card mb-4">
        <div class="card-header">ğŸ“œ æ‰§è¡Œ Ansible Playbook</div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Inventory æ–‡ä»¶</label>
                <input id="inventory" class="form-control" value="hosts">
            </div>
            <div class="mb-3">
                <label class="form-label">Playbook æ–‡ä»¶</label>
                <select id="playbook" class="form-select"></select>
                <!--  <input id="playbook" class="form-control" value="site.yml">-->
             </div>
             <button class="btn btn-success" id="runPlaybookBtn">æ‰§è¡Œ Playbook</button>
         </div>
     </div>

     <!-- æ—¥å¿—è¾“å‡º -->
    <div class="card">
        <div class="card-header">ğŸ“„ æ‰§è¡Œæ—¥å¿—</div>
        <div class="card-body">
            <pre id="log"></pre>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (() => {
        let config = {};
        let ws = null;

        // é›†ä¸­ç®¡ç†é¡µé¢å…ƒç´ 
        const elements = {
            uptime: document.getElementById("uptime"),
            load: document.getElementById("load"),
            cpu: document.getElementById("cpu"),
            cpuBar: document.getElementById("cpu-bar"),
            memory: document.getElementById("memory"),
            memoryBar: document.getElementById("memory-bar"),
            disk: document.getElementById("disk"),
            diskBar: document.getElementById("disk-bar"),
            log: document.getElementById("log"),
            inventory: document.getElementById("inventory"),
            playbook: document.getElementById("playbook"),
            runBtn: document.getElementById("runPlaybookBtn")
        };

        // åŠ è½½é…ç½®æ–‡ä»¶
        async function loadConfig() {
            try {
                const res = await fetch('/static/config.json');
                config = await res.json();
                console.log("é…ç½®å·²åŠ è½½:", config);
            } catch (err) {
                alert("é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼");
            }
        }

        // è¿æ¥ WebSocket
        function connectSystemWS() {
            if (!config.wsBaseUrl) {
                alert("é…ç½®æ–‡ä»¶ä¸­ wsBaseUrl ä¸ºç©ºï¼");
                return;
            }

            console.log(`è¿æ¥ WebSocket: ${config.wsBaseUrl}/ws-system`);
            ws = new WebSocket(`${config.wsBaseUrl}/ws-system`);

            ws.onopen = () => console.log("âœ… WebSocket å·²è¿æ¥");

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    elements.uptime.textContent = data.uptime?.trim() || "--";
                    elements.load.textContent = data.load_average || "--";

                    const cpuPercent = data.cpu_usage?.toFixed(2) || 0;
                    elements.cpu.textContent = `${cpuPercent}%`;
                    elements.cpuBar.style.width = `${cpuPercent}%`;

                    const memUsed = (data.memory_used / 1024).toFixed(1) || 0;
                    const memTotal = (data.memory_total / 1024).toFixed(1) || 0;
                    const memPercent = data.memory_total ? ((data.memory_used / data.memory_total) * 100).toFixed(1) : 0;
                    elements.memory.textContent = `${memUsed} / ${memTotal} GB`;
                    elements.memoryBar.style.width = `${memPercent}%`;

                    const diskUsed = (data.disk_used / 1024).toFixed(1) || 0;
                    const diskTotal = (data.disk_total / 1024).toFixed(1) || 0;
                    const diskPercent = data.disk_total ? ((data.disk_used / data.disk_total) * 100).toFixed(1) : 0;
                    elements.disk.textContent = `${diskUsed} / ${diskTotal} GB`;
                    elements.diskBar.style.width = `${diskPercent}%`;
                } catch (err) {
                    console.error("WebSocket æ•°æ®è§£æå‡ºé”™:", err);
                }
            };

            ws.onclose = () => {
                console.warn("WebSocket è¿æ¥å…³é—­ï¼Œ2ç§’åé‡è¿...");
                setTimeout(connectSystemWS, 2000);
            };
        }

        // æ‰§è¡Œ Ansible Playbook
        async function runAnsible() {
            try {
                const res = await fetch(`${config.apiBaseUrl}/run-ansible`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        inventory: elements.inventory.value,
                        playbook: elements.playbook.value
                    })
                });

                const reader = res.body.getReader();
                let logContent = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    logContent += new TextDecoder().decode(value);
                    elements.log.textContent = logContent;
                    elements.log.scrollTop = elements.log.scrollHeight;
                }
            } catch (err) {
                console.error("Ansible æ‰§è¡Œå¤±è´¥:", err);
            }
        }

        /// ğŸ”¹ åŠ è½½ Playbook åˆ—è¡¨
        async function loadPlaybooks() {
            try {
                let res = await fetch(`${config.apiBaseUrl}/ansible/playbooks`);
                let data = await res.json();
                let playbookSelect = elements.playbook;

                playbookSelect.innerHTML = "";  // æ¸…ç©ºåˆ—è¡¨

                data.playbooks.forEach(pb => {
                    let option = document.createElement("option");
                    option.value = pb;
                    option.text = pb;
                    playbookSelect.appendChild(option);
                });
            } catch (err) {
                console.error("âŒ åŠ è½½ Playbook å¤±è´¥", err);
            }
        }


        // é«˜äº®å¯¼èˆªæ 
        function highlightNav() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-link-custom').forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        }

        // åˆå§‹åŒ–
        window.onload = async () => {
            await loadConfig();
            connectSystemWS();
            highlightNav();
            await loadPlaybooks();  // ğŸ‘ˆ åŠ ä¸Šè¿™ä¸ªï¼
            elements.runBtn.addEventListener('click', runAnsible);
        };
    })();
</script>

</body>
</html>